<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>RiverValley Community Centre Pool Table</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0 0 70px;
            background: #f0f2f5;
        }

        h1 {
            text-align: center;
            padding: 20px;
            color: #1a1a1a;
            letter-spacing: 1px;
        }

        /* Current Game */
        #currentGameContainer.game-card {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px auto;
            padding: 25px;
            max-width: 750px;
            background: linear-gradient(135deg, #ffffff, #e0f7fa);
            border-radius: 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.12);
            font-size: 18px;
            cursor: default;
            transition: transform 0.2s;
        }
        #currentGameContainer.game-card:hover {
            transform: translateY(-3px);
        }

        .player-card {
            flex: 1;
            padding: 20px;
            border-radius: 15px;
            background: #ffffff;
            text-align: center;
            transition: transform 0.2s, background 0.2s, box-shadow 0.2s;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }
        .player-card:hover {
            transform: translateY(-5px);
            background: #e0f7fa;
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .player-name {
            font-size: 26px;
            font-weight: 700;
            color: #00796b;
        }

        .player-status {
            margin-top: 8px;
            font-size: 16px;
            color: #555;
        }

        .vs {
            font-size: 24px;
            font-weight: bold;
            color: #d81b60;
        }

        /* Next Up */
        #nextUpContainer {
            text-align: center;
            font-size: 18px;
            margin: 10px 0;
            color: #444;
        }

        /* Queue */
        ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        li {
            background: linear-gradient(135deg, #ffffff, #f1f8e9);
            margin: 8px 12px;
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            text-align: center;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        li:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.12);
        }

        /* Add Player Button */
        #addPlayerBtn {
            position: fixed;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 400px;
            padding: 18px;
            font-size: 18px;
            background: linear-gradient(135deg, #42a5f5, #1e88e5);
            color: white;
            border: none;
            border-radius: 15px;
            box-shadow: 0 6px 15px rgba(0,0,0,0.15);
            cursor: pointer;
            transition: background 0.2s, transform 0.2s;
        }
        #addPlayerBtn:hover {
            background: linear-gradient(135deg, #1e88e5, #1565c0);
            transform: translateY(-2px);
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 999;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.45);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #ffffff;
            padding: 25px;
            border-radius: 15px;
            width: 80%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        .modal input {
            width: 90%;
            padding: 12px;
            margin: 12px 0;
            font-size: 16px;
            border-radius: 8px;
            border: 1px solid #ccc;
        }
        .modal button {
            padding: 12px 20px;
            margin: 6px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
        }
        .modal .confirm { background: #42a5f5; color: white; }
        .modal .cancel { background: #ccc; }

        /* Player Options Modal Buttons */
        #playerOptions .remove { background: #ef5350; color: white; }
        #playerOptions .toEnd { background: #66bb6a; color: white; }
        #playerOptions .moveDown { background: #ffa726; color: white; }
        #currentGameModal .winner { background: #66bb6a; color: white; }
        #currentGameModal .loser { background: #ef5350; color: white; }
    </style>
</head>
<body>

<h1>RiverValley Community Centre Pool Table</h1>

<!-- Current Game -->
<div id="currentGameContainer" class="game-card">
    <div class="player-card" id="player1Card">
        <div class="player-name" id="player1">None</div>
        <div class="player-status" id="player1Status">Waiting</div>
    </div>
    <div class="vs">VS</div>
    <div class="player-card" id="player2Card">
        <div class="player-name" id="player2">None</div>
        <div class="player-status" id="player2Status">Waiting</div>
    </div>
</div>

<!-- Next Up -->
<div id="nextUpContainer">Next Up: <span id="nextUpName">None</span></div>

<!-- Queue -->
<ul id="playerList"></ul>

<button id="addPlayerBtn">+ Add Player</button>

<!-- Add Player Modal -->
<div id="playerModal" class="modal">
    <div class="modal-content">
        <h2>Add Player</h2>
        <input type="text" id="playerName" placeholder="Enter player name">
        <br>
        <button class="confirm" id="savePlayer">Add</button>
        <button class="cancel" id="cancelModal">Cancel</button>
    </div>
</div>

<!-- Queue Player Options Modal -->
<div id="playerOptions" class="modal">
    <div class="modal-content">
        <h2 id="optionTitle">Player Options</h2>
        <button class="toEnd" id="moveToEndBtn">Move to End of List</button>
        <button class="moveDown" id="moveDownBtn">Move Down</button>
        <button class="remove" id="removeBtn">Remove Player</button>
        <button class="cancel" id="closeOptions">Cancel</button>
    </div>
</div>

<!-- Current Game Modal -->
<div id="currentGameModal" class="modal">
    <div class="modal-content">
        <h2 id="currentGameTitle">Player Action</h2>
        <button class="winner" id="winnerBtn">Winner</button>
        <button class="loser" id="loserBtn">Loser</button>
        <button class="cancel" id="closeCurrentGame">Cancel</button>
    </div>
</div>

<script>
const addPlayerBtn = document.getElementById("addPlayerBtn");
const modal = document.getElementById("playerModal");
const saveBtn = document.getElementById("savePlayer");
const cancelBtn = document.getElementById("cancelModal");
const playerNameInput = document.getElementById("playerName");
const playerList = document.getElementById("playerList");
const player1Span = document.getElementById("player1");
const player2Span = document.getElementById("player2");
const nextUpName = document.getElementById("nextUpName");
const player1Status = document.getElementById("player1Status");
const player2Status = document.getElementById("player2Status");

const optionsModal = document.getElementById("playerOptions");
const optionTitle = document.getElementById("optionTitle");
const moveToEndBtn = document.getElementById("moveToEndBtn");
const moveDownBtn = document.getElementById("moveDownBtn");
const removeBtn = document.getElementById("removeBtn");
const closeOptions = document.getElementById("closeOptions");

const currentGameModal = document.getElementById("currentGameModal");
const currentGameTitle = document.getElementById("currentGameTitle");
const winnerBtn = document.getElementById("winnerBtn");
const loserBtn = document.getElementById("loserBtn");
const closeCurrentGame = document.getElementById("closeCurrentGame");

let queue = [];
let currentGame = [null, null];
let currentPlayerOption = null;
let currentGameIndex = null;

addPlayerBtn.onclick = () => { modal.style.display = "flex"; playerNameInput.value = ""; playerNameInput.focus(); };
cancelBtn.onclick = () => { modal.style.display = "none"; };

saveBtn.onclick = async () => {
    const name = playerNameInput.value.trim();
    if (name) {
        await fetch("/players?name=" + encodeURIComponent(name), { method: "POST" });
        modal.style.display = "none";
        loadPlayers();
    }
};

async function loadPlayers() {
    const res = await fetch("/players");
    const players = await res.json();

    if (!currentGame[0] && players.length > 0) currentGame[0] = players[0];
    if (!currentGame[1] && players.length > 1) currentGame[1] = players[1];

    queue = players.filter(p => !currentGame.some(cg => cg?.id === p.id));

    renderQueue();
    renderCurrentGame();
    updateNextUp();
}

function renderQueue() {
    playerList.innerHTML = "";
    queue.forEach(p => {
        const li = document.createElement("li");
        li.textContent = p.name;
        li.onclick = () => {
            currentPlayerOption = p;
            optionTitle.textContent = `Options for ${p.name}`;
            optionsModal.style.display = "flex";
        };
        playerList.appendChild(li);
    });
}

function renderCurrentGame() {
    player1Span.textContent = currentGame[0]?.name || "None";
    player2Span.textContent = currentGame[1]?.name || "None";
    player1Status.textContent = currentGame[0] ? "Playing" : "Waiting";
    player2Status.textContent = currentGame[1] ? "Playing" : "Waiting";
}

function updateNextUp() {
    nextUpName.textContent = queue.length > 0 ? queue[0].name : "None";
}

function handleCurrentGameClick(index) {
    if (!currentGame[index]) return;
    currentGameIndex = index;
    currentGameTitle.textContent = `Player ${currentGame[index].name} Action`;
    currentGameModal.style.display = "flex";
}

winnerBtn.onclick = async () => {
    if (currentGameIndex === null) return;
    const otherIndex = currentGameIndex === 0 ? 1 : 0;
    const loser = currentGame[otherIndex];
    if (loser) await fetch(`/players/${loser.id}/moveToEnd`, { method: "PUT" });
    currentGame[otherIndex] = queue.length > 0 ? queue.shift() : null;
    currentGameModal.style.display = "none";
    currentGameIndex = null;
    renderCurrentGame();
    renderQueue();
    updateNextUp();
};

loserBtn.onclick = async () => {
    if (currentGameIndex === null) return;
    const loser = currentGame[currentGameIndex];
    if (loser) await fetch(`/players/${loser.id}/moveToEnd`, { method: "PUT" });
    currentGame[currentGameIndex] = queue.length > 0 ? queue.shift() : null;
    currentGameModal.style.display = "none";
    currentGameIndex = null;
    renderCurrentGame();
    renderQueue();
    updateNextUp();
};

moveToEndBtn.onclick = async () => {
    if (!currentPlayerOption) return;
    await fetch(`/players/${currentPlayerOption.id}/moveToEnd`, { method: "PUT" });
    optionsModal.style.display = "none";
    loadPlayers();
};

moveDownBtn.onclick = async () => {
    if (!currentPlayerOption) return;
    await fetch(`/players/${currentPlayerOption.id}/moveDown`, { method: "PUT" });
    optionsModal.style.display = "none";
    loadPlayers();
};

removeBtn.onclick = async () => {
    if (!currentPlayerOption) return;
    await fetch(`/players/${currentPlayerOption.id}`, { method: "DELETE" });
    optionsModal.style.display = "none";
    loadPlayers();
};

closeOptions.onclick = () => { optionsModal.style.display = "none"; };
closeCurrentGame.onclick = () => { currentGameModal.style.display = "none"; currentGameIndex = null; };

document.getElementById("player1Card").onclick = () => handleCurrentGameClick(0);
document.getElementById("player2Card").onclick = () => handleCurrentGameClick(1);

window.onclick = (e) => {
    if (e.target === modal) modal.style.display = "none";
    if (e.target === optionsModal) optionsModal.style.display = "none";
    if (e.target === currentGameModal) currentGameModal.style.display = "none";
};

loadPlayers();
setInterval(loadPlayers, 3000);
</script>
</body>
</html>
